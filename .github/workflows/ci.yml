name: ci

on:
  push:
    branches: [ "main" ]

env:
  APP_NAME: hello-argocd-and-github-actions
  IMAGE_REPO: docker.io/wellrcosta/hello-argocd-and-github-actions

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout app
        uses: actions/checkout@v4

      - name: Docker login (Docker Hub)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_REPO }}:${{ github.sha }}
            ${{ env.IMAGE_REPO }}:latest
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update env-infra values with new tag
        run: |
          set -euo pipefail
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          # Clona o env-infra com PAT (precisa ter permissão de escrita)
          git clone https://x-access-token:${{ secrets.ENV_INFRA_PAT }}@github.com/wellrcosta/env-infra.git
          cd env-infra

          # Garante pasta do app
          mkdir -p apps/${{ env.APP_NAME }}

          # Se não existir, cria um values.yaml mínimo (porta 80 e /health)
          if [ ! -f "apps/${{ env.APP_NAME }}/values.yaml" ]; then
            cat > apps/${{ env.APP_NAME }}/values.yaml <<EOF
image:
  repository: ${{ env.IMAGE_REPO }}
  tag: "${{ github.sha }}"
  pullPolicy: IfNotPresent

replicaCount: 1

containerPort: 80
probes:
  enabled: true
  path: /health
  initialDelaySeconds: 3
  periodSeconds: 10
  timeoutSeconds: 2
  failureThreshold: 3

service:
  port: 80

ingress:
  enabled: true
  className: traefik

extraEnv:
  - name: PORT
    value: "80"

secret:
  enabled: false
  name: ""
  data: {}

cronjobs:
  enabled: false
  items: []

resources:
  requests:
    cpu: "50m"
  limits:
    cpu: "250m"
    memory: "256Mi"
EOF
          fi

          # Atualiza a tag para o SHA atual
          sed -i -E "s#^( *tag:).*#\1 \"${GITHUB_SHA}\"#" apps/${{ env.APP_NAME }}/values.yaml

          git add apps/${{ env.APP_NAME }}/values.yaml
          if ! git diff --cached --quiet; then
            git commit -m "ci: update ${APP_NAME} image tag -> ${GITHUB_SHA}"
            git push origin main
          else
            echo "nothing to commit"
          fi
